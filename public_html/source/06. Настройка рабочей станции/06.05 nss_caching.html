<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>nss caching</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
body { font:80% Verdana,Tahoma,Arial,sans-serif; }
h1, h2, h3, h4 {  font-family: "Trebuchet MS",Georgia,"Times New Roman",serif; }
ul.toc { padding: 4px; margin-left: 0; }
ul.toc li { list-style-type:none; }
ul.toc li.heading2 { margin-left: 1em; }
ul.toc li.heading3 { margin-left: 2em; }
a.wiki-anchor { display: none; margin-left: 6px; text-decoration: none; }
a.wiki-anchor:hover { color: #aaa !important; text-decoration: none; }
h1:hover a.wiki-anchor, h2:hover a.wiki-anchor, h3:hover a.wiki-anchor { display: inline; color: #ddd; }
pre {font-size:133% }
</style>
</head>
<body>
<h1 id="Реализация-кэширования-NSS-для-доменной-машины">Реализация кэширования NSS для доменной машины<a href="#Реализация-кэширования-NSS-для-доменной-машины" class="wiki-anchor">&para;</a></h1>


	<p><strong>LDAP</strong> - относительно простой протокол, использующий TCP/IP и позволяющий производить операции аутентификации (bind), поиска (search) и сравнения (compare), а также операции добавления, изменения или удаления записей. Обычно LDAP-сервер принимает входящие соединения на порт 389 по протоколам TCP или UDP.</p>


	<p><strong>NetworkManager</strong> - программа для управления сетевыми соединениями в Linux. Для использования NetworkManager в графическом интерфейсе, существует программа nm-applet, которая соответствует стандарту Freedesktop.org System Tray Protocol, включая KDE, XFCE, GNOME. NetworkManager использует D-Bus, udev и PolicyKit. Компоненты взаимодействуют через D-Bus.</p>


	<p><strong>D-Bus</strong> - система межпроцессного взаимодействия, которая позволяет приложениям в операционной системе общаться друг с другом.</p>


	<p><strong>PolicyKit</strong> - набор инструментов разработки для контроля системных привилегий в Unix-подобных операционных системах. Он даёт возможность непривилегированным процессам общаться с привилегированными.</p>


Для авторизации сетевых пользователей Calculate Linux Desktop использует LDAP сервер. Во время работы доменного пользователя при продолжительном отключении сети могут возникнуть следующие проблемы:
	<ul>
	<li>недоступен LDAP;</li>
		<li>нет возможности авторизовать пользователя (авторизация через LDAP);</li>
		<li>если сеанс пользователя заблокирован - его не разблокировать;</li>
		<li>нет возможности восстановить сетевое соединение (действие с сетью требуют информацию о пользователе).</li>
	</ul>


	<p>Эти же сложности могут возникнуть и при выходе компьютера из спящего режима.</p>


	<h2 id="Использование-Nscd">Использование Nscd<a href="#Использование-Nscd" class="wiki-anchor">&para;</a></h2>


	<p>Получение информации о пользователях осуществляется при помощи диспетчера службы имён <strong>NSS</strong> (Name Service Switch). Порядок и источники данных описываются в файле <code>/etc/nsswitch.conf</code>. В случае введенной в домен машины источника данных два: <code>files</code> (<code>/etc/passwd</code>, <code>/etc/group</code>) и <code>LDAP</code>. Для того, чтобы NSS информация из LDAP не пропадала при отключении сети, в Calculate Linux Desktop начиная с версии 13.11 работает демон Nscd.</p>


	<p><strong>Nscd</strong> - это служба, которая кэширует запросы службы имён. Она содержит два кэша на каждую категорию: попаданий (найденный элемент) и промахов (ненайденные элемены). Каждый кэш имеет для своих данных отдельный TTL (время жизни). Эти параметры настраиваются в <code>/etc/nscd.conf</code>. Для того, чтобы программа использовала кэширование, nscd должен быть запущен перед ней. Таким образом NSS кэш может решить проблему отключения сети, благодаря тому, что информация о пользователе будет получаться из кэша, пока он не устареет, даже если нет соединения с LDAP.</p>


	<p>Ранний запуск nscd порождает проблему связанную с аутентификацией доменного пользователя до поднятия сети. В pam.d/system-auth используется модуль pam_client для ожидания соединения с LDAP если введен пользователь и пароль до поднятия сети. Проблема возникает из-за кэша промахов: менеджер входа в сеанс (lightdm) успевает до вызова pam_client запросить от NSS информацию об аутентифицируемом пользователе, а так как соединения с LDAP на этот момент нет, то пользователь попадает в кэш промахов и в течении времени жизни этого кэша программы будут получать результат о том, что пользователь не существует, даже если LDAP уже доступен. Для решения этой проблемы, при запуске демона кэш промахов отключён. Включается он уже в конце загрузки системы службой "local". Для реализации этого, в системе содержатся два файла настроек <code>/etc/nscd.conf</code> (без кэша), <code>/etc/nscd-cache.conf</code> (с кэшем).</p>


	<p>Для того, чтобы можно было переводить компьютер в спящий режим на несколько часов/дней и при этом не терять закэшированную информацию после пробуждения, TTL кэша попаданий установлено на 7 дней. В этом случае возникает проблема актуальности записей в кэше: пользователь может быть удален из LDAP, но при этом он будет присутствовать в кэше. Для решения этой проблемы кэш обновляется при входе доменного пользователя в сеанс, при пробуждении компьютера из спящего/ждущего режима, а также по cron-у раз в три часа (интервал в часах может быть изменен при помощи переменной <code>client.cl_client_nscd_cache</code>), при условии, что LDAP сервер доступен. Для принудительно вызова обновления кэша можно использовать команду <span class="bluecode" >nscd-refresh</span>.</p>


	<h2 id="Назначение-pam_client">Назначение pam_client<a href="#Назначение-pam_client" class="wiki-anchor">&para;</a></h2>


<strong>Pam_client</strong> предназначен для ожидания LDAP сервера перед аутентификацией и выполняет следующие действия:
	<ol>
	<li>на основании файлов <code>/etc/passwd</code> и <code>/var/lib/calculate/calculate-client/cache/passwd</code> определят является ли аутентифицируемый пользователь локальным;</li>
		<li>если пользователь не локальный, модуль ждет запуск службы <code>client</code>;</li>
		<li>после этого проверяет доступность LDAP сервера.</li>
	</ol>


	<p>Определение локального пользователя необходимо для того, чтобы не выполнять ожидание если введен неверный пароль для локального пользователя. Ожидание службы client необходимо, для того, чтобы система была загружена и настроена на работу с доменом, перед тем как доменный пользователь будет авторизован и войдет в сессию. Ожидание LDAP сервера используется при разблокировании сеанса пользователя, после выхода из спящего режима, пока сеть не поднялась.</p>
</body>
</html>
