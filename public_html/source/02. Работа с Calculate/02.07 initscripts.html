<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>initscripts</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
body { font:80% Verdana,Tahoma,Arial,sans-serif; }
h1, h2, h3, h4 {  font-family: "Trebuchet MS",Georgia,"Times New Roman",serif; }
ul.toc { padding: 4px; margin-left: 0; }
ul.toc li { list-style-type:none; }
ul.toc li.heading2 { margin-left: 1em; }
ul.toc li.heading3 { margin-left: 2em; }
a.wiki-anchor { display: none; margin-left: 6px; text-decoration: none; }
a.wiki-anchor:hover { color: #aaa !important; text-decoration: none; }
h1:hover a.wiki-anchor, h2:hover a.wiki-anchor, h3:hover a.wiki-anchor { display: inline; color: #ddd; }
pre {font-size:133% }
</style>
</head>
<body>
<h1 id="Сценарии-инициализации">Сценарии инициализации<a href="#Сценарии-инициализации" class="wiki-anchor">&para;</a></h1>


	<ul class="toc"><li class="heading1"><a href="#Сценарии-инициализации">Сценарии инициализации</a></li>
<li class="heading2"><a href="#Уровни-запуска">Уровни запуска</a></li>
<li class="heading3"><a href="#Процесс-загрузки-системы">Процесс загрузки системы</a></li>
<li class="heading3"><a href="#Сценарии-инициализации">Сценарии инициализации</a></li>
<li class="heading3"><a href="#Как-работает-init">Как работает init</a></li>
<li class="heading3"><a href="#Что-такое-уровень-запуска">Что такое уровень запуска?</a></li>
<li class="heading3"><a href="#Работа-со-сценариями-инициализации">Работа со сценариями инициализации</a></li>
<li class="heading2"><a href="#Использование-rc-update">Использование rc-update</a></li>
<li class="heading3"><a href="#Что-такое-rc-update">Что такое rc-update?</a></li>
<li class="heading3"><a href="#Добавление-и-удаление-служб">Добавление и удаление служб</a></li>
<li class="heading2"><a href="#Настройка-служб">Настройка служб</a></li>
<li class="heading3"><a href="#Почему-нужна-дополнительная-настройка">Почему нужна дополнительная настройка?</a></li>
<li class="heading3"><a href="#Каталог-etcconfd">Каталог /etc/conf.d</a></li>
<li class="heading2"><a href="#Написание-сценариев-инициализации">Написание сценариев инициализации</a></li>
<li class="heading3"><a href="#Мне-тоже-придется">Мне тоже придется?..</a></li>
<li class="heading3"><a href="#Структура">Структура</a></li>
<li class="heading3"><a href="#Зависимости">Зависимости</a></li>
<li class="heading3"><a href="#Порядок-запуска">Порядок запуска</a></li>
<li class="heading3"><a href="#Стандартные-функции">Стандартные функции</a></li>
<li class="heading3"><a href="#Добавление-дополнительных-параметров">Добавление дополнительных параметров</a></li>
<li class="heading3"><a href="#Переменные-для-настройки-служб">Переменные для настройки служб</a></li>
<li class="heading3"><a href="#Кто-от-этого-выиграет">Кто от этого выиграет?</a></li>
<li class="heading3"><a href="#Использование-программного-уровня-softlevel">Использование программного уровня (softlevel)</a></li>
<li class="heading3"><a href="#Использование-загрузочного-уровня-bootlevel">Использование загрузочного уровня (bootlevel)</a></li>
</ul>


	<h2 id="Уровни-запуска">Уровни запуска<a href="#Уровни-запуска" class="wiki-anchor">&para;</a></h2>


	<h3 id="Процесс-загрузки-системы">Процесс загрузки системы<a href="#Процесс-загрузки-системы" class="wiki-anchor">&para;</a></h3>


	<p>При загрузке вашей системы по экрану пробегает много текста. Если присмотреться, заметно, что этот текст не меняется от загрузки к загрузке. Последовательность всех этих действий называется <em>последовательностью загрузки</em> и в той или иной степени постоянна.</p>


	<p>Во-первых, загрузчик размещает в памяти образ ядра, который вы указали в файле его конфигурации. После этого ядро запускается. Когда ядро загружено и запущено, оно инициализирует относящиеся к ядру структуры и задания, и запускает процесс <span class="bluecode" >init</span>.</p>


	<p>Этот процесс удостоверяется, что все файловые системы (определенные в <code>/etc/fstab</code>) смонтированы и готовы к использованию. Затем он выполняет несколько сценариев, находящихся в каталоге <code>/etc/init.d</code>, которые запускают службы, необходимые для нормального запуска системы.</p>


	<p>И, наконец, когда все сценарии выполнены, <code>init</code> подключает терминалы (чаще всего просто виртуальные консоли, которые видны при нажатии <span class="bluecode" >ALT+F1</span>, <span class="bluecode" >ALT+F2</span> и т.д.), прикрепляя к каждой консоли специальный процесс под названием <span class="bluecode" >agetty</span>. Этот процесс впоследствии обеспечивает возможность входа в систему с помощью <span class="bluecode" >login</span>.</p>


	<h3 id="Сценарии-инициализации">Сценарии инициализации<a href="#Сценарии-инициализации" class="wiki-anchor">&para;</a></h3>


	<p>Сейчас процесс <span class="bluecode" >init</span> запускает сценарии из каталога <code>/etc/init.d</code> не в случайном порядке. Более того, запускаются не все сценарии из <code>/etc/init.d</code>, а только те, которые предписано исполнять. Решение о запуске сценария принимается в результате просмотра каталога <code>/etc/runlevels</code>.</p>


	<p>Во-первых, <span class="bluecode" >init</span> запускает все сценарии из <code>/etc/init.d</code>, на которые есть символьные ссылки из /etc/runlevels/boot. Обычно сценарии запускаются в алфавитном порядке, но в некоторых сценариях имеется информация о зависимостях от других сценариев, указывающая системе на необходимость их предварительного запуска.</p>


	<p>Когда все сценарии, указанные в <code>/etc/runlevels/boot</code>, будут выполнены, <span class="bluecode" >init</span> переходит к запуску сценариев, на которые есть символьные ссылки из <code>/etc/runlevels/default</code>. И снова запуск происходит в алфавитном порядке, пока в сценарии не встретится информация о зависимостях; тогда порядок изменяется для обеспечения правильного порядка запуска.</p>


	<h3 id="Как-работает-init">Как работает init<a href="#Как-работает-init" class="wiki-anchor">&para;</a></h3>


	<p>Конечно, <span class="bluecode" >init</span> не принимает решений сам по себе. Ему необходим конфигурационный файл, где описаны необходимые действия. Этот файл — <code>/etc/inittab</code>.</p>


	<p>Если вы запомнили последовательность загрузки, описанную чуть ранее, вы вспомните, что первое действие <span class="bluecode" >init</span> — это монтирование всех файловых систем. Это определяется в строке <code>/etc/inittab</code>, приведенной ниже:</p>


	<pre><code>si::sysinit:/sbin/rc sysinit</code></pre>


	<p>Этой строкой процессу <span class="bluecode" >init</span> предписывается выполнить <span class="bluecode" >/sbin/rc sysinit</span> для инициализации системы. Самой инициализацией занимается сценарий <code>/sbin/rc</code>, так что можно сказать, что <span class="bluecode" >init</span> делает не слишком много — он просто делегирует задачу по инициализации системы другому процессу.</p>


	<p>Во-вторых, <span class="bluecode" >init</span> выполняет все сценарии, на которые есть символьные ссылки из <code>/etc/runlevels/boot</code>. Это определяется следующей строкой:</p>


	<pre><code>rc::bootwait:/sbin/rc boot</code></pre>


	<p>И снова все необходимые действия выполняются сценарием <span class="bluecode" >rc</span>. Заметьте, что параметр, переданный <span class="bluecode" >rc</span> (<em>boot</em>), совпадает с названием используемого подкаталога в <code>/etc/runlevels</code>.</p>


	<p>Теперь <span class="bluecode" >init</span> проверяет свой конфигурационный файл, чтобы определить, какой уровень запуска использовать. Для этого из <code>/etc/inittab</code> считывается строка:</p>


	<pre><code>id:3:initdefault:</code></pre>


	<p>В приведенном примере (который подходит для подавляющего большинства пользователей Calculate) номер <em>уровня запуска</em> — 3. Пользуясь этой информацей, <span class="bluecode" >init</span> проверяет, что нужно выполнить для запуска <em>уровня запуска</em> 3. Пример уровней запуска:</p>


	<pre><code>l0:0:wait:/sbin/rc shutdown<br />l1:S1:wait:/sbin/rc single<br />l2:2:wait:/sbin/rc nonetwork<br />l3:3:wait:/sbin/rc default<br />l4:4:wait:/sbin/rc default<br />l5:5:wait:/sbin/rc default<br />l6:6:wait:/sbin/rc reboot</code></pre>


	<p>В строке, определяющей уровень 3, для запуска служб снова используется сценарий <span class="bluecode" >rc</span> (на этот раз с аргументом <em>default</em>). Опять-таки, обратите внимание, что аргумент, передаваемый сценарию <span class="bluecode" >rc</span>, совпадает с названием подкаталога из <code>/etc/runlevels</code>.</p>


	<p>По окончании работы <span class="bluecode" >rc</span>, <span class="bluecode" >init</span> принимает решение о том, какие виртуальные консоли включить и какие команды выполнить в каждой из них. Пример определения виртуальных консолей:</p>


	<pre><code>c1:12345:respawn:/sbin/agetty 38400 tty1 linux<br />c2:12345:respawn:/sbin/agetty 38400 tty2 linux<br />c3:12345:respawn:/sbin/agetty 38400 tty3 linux<br />c4:12345:respawn:/sbin/agetty 38400 tty4 linux<br />c5:12345:respawn:/sbin/agetty 38400 tty5 linux<br />c6:12345:respawn:/sbin/agetty 38400 tty6 linux</code></pre>


	<h3 id="Что-такое-уровень-запуска">Что такое уровень запуска?<a href="#Что-такое-уровень-запуска" class="wiki-anchor">&para;</a></h3>


	<p>Как вы заметили, <span class="bluecode" >init</span> применяет нумерацию для определения <em>уровня запуска</em>, который надо использовать. <em>Уровень запуска</em> — это то состояние, в котором запускается ваша система; он содержит набор сценариев (сценариев уровня запуска или <em>сценариев инициализации [initscript]</em>), которые следует выполнять при входе и выходе из определенного уровня запуска.</p>


	<p>В Calculate определено семь уровней запуска: три служебных и четыре определяемых пользователем. Служебные называются <em>sysinit</em>, <em>shutdown</em> и <em>reboot</em>. Действия, совершаемые ими, в точности соответствуют их названиям: инициализация системы, выключение системы и ее перезагрузка.</p>


	<p>Определяемые пользователем уровни — это те, которым соответствуют подкаталоги в <code>/etc/runlevels</code>: <code>boot</code>, <code>default</code>, <code>nonetwork</code> и <code>single</code>. Уровень <code>boot</code> запускает все службы, необходимые системе и используемые всеми остальными уровнями. Остальные уровни отличаются друг от друга запускаемыми службами: <code>default</code> используется для повседневной работы, <code>nonetwork</code> — для тех случаев, когда не требуется сеть, а <code>single</code> — при необходимости восстановления системы.</p>


	<h3 id="Работа-со-сценариями-инициализации">Работа со сценариями инициализации<a href="#Работа-со-сценариями-инициализации" class="wiki-anchor">&para;</a></h3>


	<p>Сценарии, запускаемые процессом <span class="bluecode" >rc</span>, называются <em>сценариями инициализации</em>. Каждый сценарий из <code>/etc/init.d</code> может запускаться с аргументами <em>start, stop, restart, pause, zap, status, ineed, iuse, needsme, usesme</em> и <em>broken</em>.</p>


	<p>Для запуска, остановки или перезапуска службы (и всех, зависящих от нее) следует использовать <span class="bluecode" >start</span>, <span class="bluecode" >stop</span> и <span class="bluecode" >restart</span>. Пример запуска postfix:</p>


	<pre><code>/etc/init.d/postfix start</code></pre>


	<p>Примечание: Останавливаются или перезапускаются только те службы, которым <em>необходима</em> данная служба. Остальные зависимые службы (те, которые <em>используют</em> службу, но не нуждаются в ней) эта операция не затрагивает.</p>


	<p>Если вы хотите остановить службу, но оставить зависимые от нее работающими, можно использовать аргумент <span class="bluecode" >pause</span>. Пример:</p>


	<pre><code>/etc/init.d/postfix pause</code></pre>


	<p>Чтобы узнать текущее состояние службы (запущена, остановлена, приостановлена и т.д.), можно использовать аргумент <span class="bluecode" >status</span>. Пример:</p>


	<pre><code>/etc/init.d/postfix status</code></pre>


	<p>Если указано, что служба работает, но вы знаете, что это не так, можно сбросить состояние на stopped (остановлена), используя аргумент <span class="bluecode" >zap</span>. Пример сброса информации о состоянии postfix:</p>


	<pre><code>/etc/init.d/postfix zap</code></pre>


	<p>Для того, чтобы выяснить зависимости службы, можно использовать аргументы <span class="bluecode" >iuse</span> или <span class="bluecode" >ineed</span>. С помощью <span class="bluecode" >ineed</span> вы увидите те службы, которые действительно необходимы для правильного функционирования интересующей вас службы. С другой стороны, <span class="bluecode" >iuse</span> покажет те службы, которые могут использоваться нашей службой, но не обязательны для ее работы. Пример запроса списка всех необходимых служб, от которых зависит Postfix:</p>


	<pre><code>/etc/init.d/postfix needsme</code></pre>


	<p>Наконец, можно просмотреть список служб, требующихся для данной, но отсутствующих в системе. Пример запроса списка служб, необходимых Postfix, но отсутствующих:</p>


	<pre><code>/etc/init.d/postfix broken</code></pre>


	<h2 id="Использование-rc-update">Использование rc-update<a href="#Использование-rc-update" class="wiki-anchor">&para;</a></h2>


	<h3 id="Что-такое-rc-update">Что такое rc-update?<a href="#Что-такое-rc-update" class="wiki-anchor">&para;</a></h3>


	<p>Система инициализации Calculate использует дерево зависимостей для определения служб, которые запускаются в первую очередь. Т. к. это очень утомительное занятие, и мы не хотели, чтобы пользователь занимался этим вручную, были разработаны инструменты, упрощающие управление уровнями запуска и сценариями инициализации.</p>


	<p>Используя <span class="bluecode" >rc-update</span>, можно включать и исключать сценарии инициализации из уровней запуска. Из <span class="bluecode" >rc-update</span> автоматически запускается сценарий <span class="bluecode" >depscan.sh</span>, который перестраивает дерево зависимостей.</p>


	<h3 id="Добавление-и-удаление-служб">Добавление и удаление служб<a href="#Добавление-и-удаление-служб" class="wiki-anchor">&para;</a></h3>


	<p>В процессе установки Calculate вы могли добавлять сценарии инициализации в уровень запуска "default". В тот момент вы, возможно, не имели понятия, что такое "default" и зачем он нужен, но теперь вы это знаете. Сценарию rc-update требуется второй аргумент, определяющий действие: <em>add</em> (добавить), <em>del</em> (удалить) или <em>show</em> (показать).</p>


	<p>Для того, чтобы добавить или удалить сценарий, просто введите <span class="bluecode" >rc-update</span> с аргументом <span class="bluecode" >add</span> или <span class="bluecode" >del</span>, затем название сценария и уровня запуска. Пример удаления Postfix из уровня запуска default:</p>


	<pre><code>rc-update del postfix default</code></pre>


	<p>По команде <span class="bluecode" >rc-update show</span> выводится список всех доступных сценариев с указанием соответствующих уровней запуска. Пример получения информации о сценариях инициализации:</p>


	<pre><code>rc-update show</code></pre>


	<h2 id="Настройка-служб">Настройка служб<a href="#Настройка-служб" class="wiki-anchor">&para;</a></h2>


	<h3 id="Почему-нужна-дополнительная-настройка">Почему нужна дополнительная настройка?<a href="#Почему-нужна-дополнительная-настройка" class="wiki-anchor">&para;</a></h3>


	<p>Сценарии инициализации могут быть весьма сложны. Поэтому нежелательно допускать непосредственное редактирование сценария пользователями, т.к. это может привнести в систему множество ошибок. Но, с другой стороны, необходимо правильно настроить службу. Например, может понадобиться передать службе дополнительные параметры.</p>


	<p>Вторая причина, по которой настройки хранятся отдельно от самого сценария — это возможность обновления сценария без опасения, что все ваши настройки будут утеряны.</p>


	<h3 id="Каталог-etcconfd">Каталог /etc/conf.d<a href="#Каталог-etcconfd" class="wiki-anchor">&para;</a></h3>


	<p>В Calculate предусмотрен очень простой способ настройки служб: для каждого сценария, предполагающего настройку, в каталоге <code>/etc/conf.d</code> есть конфигурационный файл. Например, у сценария, запускающего apache2 (под названием <code>/etc/init.d/apache2</code>), есть конфигурационный файл <code>/etc/conf.d/apache2</code>, где могут храниться нужные вам параметры, передаваемые серверу Apache 2 при запуске. Пример переменной, определенной в <code>/etc/conf.d/apache2</code>:</p>


	<pre><code>APACHE2_OPTS="-D PHP4"</code></pre>


	<p>Такие файлы настроек содержат одни переменные (наподобие <a href="/etc/make.conf.html" class="wiki-page">/etc/make.conf</a>), облегчая настройку служб. Это также позволяет нам давать больше информации о переменных (в комментариях).</p>


	<h2 id="Написание-сценариев-инициализации">Написание сценариев инициализации<a href="#Написание-сценариев-инициализации" class="wiki-anchor">&para;</a></h2>


	<h3 id="Мне-тоже-придется">Мне тоже придется?..<a href="#Мне-тоже-придется" class="wiki-anchor">&para;</a></h3>


	<p>Нет, написание сценариев инициализации обычно не требуется, т.к. Calculate содержит готовые сценарии для всех поддерживаемых служб. Однако, вы можете установить какую-либо службу, не используя систему Portage; в таком случае, вероятно, вам придется создавать сценарий инициализации самостоятельно.</p>


	<h3 id="Структура">Структура<a href="#Структура" class="wiki-anchor">&para;</a></h3>


	<p>Основная структура сценария инициализации показана ниже.<br /><pre>
#!/sbin/runscript

depend() {
  (информация о зависимостях)
}

start() {
  (команды, необходимые для запуска службы)
}

stop() {
  (команды, необходимые для остановки службы)
}

restart() {
  (команды, необходимые для перезапуска службы)
}
</pre></p>


	<p>В любом сценарии должна быть определена функция <span class="bluecode" >start()</span>. Все остальные разделы необязательны.</p>


	<h3 id="Зависимости">Зависимости<a href="#Зависимости" class="wiki-anchor">&para;</a></h3>


	<p>Можно определять два типа зависимостей: <span class="bluecode" >use</span> (использую) и <span class="bluecode" >need</span> (нуждаюсь). Как упоминалось ранее, <span class="bluecode" >need</span>-зависимость более строга, чем <span class="bluecode" >use</span>-зависимость. Вслед за типом зависимости указывается название службы, от которой существует зависимость, или ссылка на <em>виртуальную</em> (virtual) зависимость.</p>


	<p><em>Виртуальная</em> зависимость — это зависимость от функций, предоставляемых службой, но не какой-то единственной службой. Сценарий может зависеть от службы системного журнала, но таких достаточно много (metalogd, syslog-ng, sysklogd и т.п.). Поскольку нельзя нуждаться в каждой из них (ни в одной корректно работающей системе они не запущены все сразу), мы обеспечили <em>предоставление</em> виртуальной зависимости всеми этими службами.</p>


	<p>Давайте взглянем на информацию о зависимостях postfix:<br /><pre>
depend() {
  need net
  use logger dns
  provide mta
}
</pre></p>


	<p>Как можно увидеть, postfix:</p>


	<ul>
	<li>требует сеть (net): виртуальная зависимость, удовлетворяемая, например, <code>/etc/init.d/net.eth0</code></li>
		<li>использует журнал (logger): виртуальная зависимость, удовлетворяемая, например, <code>/etc/init.d/syslog-ng</code></li>
		<li>использует службу имен (dns): виртуальная зависимость, удовлетворяемая, например, <code>/etc/init.d/named</code></li>
		<li>предоставляет почтовый агент (mta): виртуальная зависимость, общая для всех программ — почтовых серверов</li>
	</ul>


	<h3 id="Порядок-запуска">Порядок запуска<a href="#Порядок-запуска" class="wiki-anchor">&para;</a></h3>


	<p>Иногда вам нужна не сама служба, а запуск вашей службы <span class="bluecode" >до</span> (или <em>после</em>) другой службы, <em>если</em> та присутствует в системе (обратите внимание на условие: это уже не зависимость) <em>и</em> запускается на том же уровне запуска (отметьте условие: это относится только к службам из одинакового уровня запуска). Такую очередность можно указать, используя значения <span class="bluecode" >before</span> (до) или <span class="bluecode" >after</span> (после).</p>


	<p>Например, рассмотрим значения для службы Portmap. Пример функции depend() службы Portmap:<br /><pre>
depend() {
  need net
  before inetd
  before xinetd
}
</pre></p>


	<p>Также можно использовать знак "*", чтобы охватить все службы данного уровня запуска, хотя это не рекомендуется. Пример запуска сценария первым на уровне запуска:<br /><pre>
depend() {
  before *
}
</pre></p>


	<h3 id="Стандартные-функции">Стандартные функции<a href="#Стандартные-функции" class="wiki-anchor">&para;</a></h3>


	<p>Следом за разделом <span class="bluecode" >depend()</span> вам потребуется определить функцию <span class="bluecode" >start()</span>. В ней содержатся все команды, необходимые для запуска вашей службы. Рекомендуется применять функции <span class="bluecode" >ebegin</span> и <span class="bluecode" >eend</span> для сообщений пользователю о том, что происходит. Пример функции start():<br /><pre>
start() {
  ebegin "Запуск - моя_служба" 
  start-stop-daemon --start --quiet --exec /path/to/my_service
  eend $?
}
</pre></p>


	<p>Если вам нужны дополнительные примеры функции <span class="bluecode" >start()</span>, пожалуйста, прочитайте исходные коды сценариев инициализации, находящихся в каталоге <code>/etc/init.d</code>. Что касается команды <span class="bluecode" >start-stop-daemon</span>, то на случай, если вам нужны дополнительные сведения, есть превосходная страница справки. Пример вызова страницы справки по start-stop-daemon:</p>


	<pre><code>man start-stop-daemon</code></pre>


	<p>Другими функциями, которые можно определить — <span class="bluecode" >stop()</span> и <span class="bluecode" >restart()</span>. От вас не требуется определение этих функций! Система инициализации, применяемая нами, достаточно развита и в состоянии самостоятельно заполнить эти функции, если вы используете <span class="bluecode" >start-stop-daemon</span>.</p>


	<p>Синтаксис сценариев инициализации, применяемых в Calculate, основан на оболочке Борна (Bourne Again Shell — bash), поэтому вы можете свободно использовать внутри своих сценариев bash-совместимые конструкции.</p>


	<h3 id="Добавление-дополнительных-параметров">Добавление дополнительных параметров<a href="#Добавление-дополнительных-параметров" class="wiki-anchor">&para;</a></h3>


	<p>Если вы хотите ввести в сценарий дополнительные параметры, кроме упоминавшихся, нужно добавить к переменной <span class="bluecode" >opts</span> название параметра и создать функцию с названием, соответствующим параметру. Например, для поддержки параметра <span class="bluecode" >restartdelay</span>. Пример создания дополнительной функции restartdelay:<br /><pre>
opts="${opts} restartdelay" 

restartdelay() {
  stop
  sleep 3    # пауза в 3 секунды перед повторным запуском
  start
}
</pre></p>


	<h3 id="Переменные-для-настройки-служб">Переменные для настройки служб<a href="#Переменные-для-настройки-служб" class="wiki-anchor">&para;</a></h3>


	<p>Для поддержки конфигурационного файла в каталоге <code>/etc/conf.d</code> ничего дополнительно делать не нужно: при запуске вашего сценария инициализации автоматически включаются следующие файлы (т.е., переменные из них становятся доступны):</p>


	<ul>
	<li><code>/etc/conf.d/&lt;ваш сценарий инициализации&gt;</code></li>
		<li><code>/etc/conf.d/basic</code></li>
		<li><code>/etc/rc.conf</code></li>
	</ul>


	<p>Если ваш инициализационный сценарий предоставляет виртуальную зависимость (например, <span class="bluecode" >net</span>), то также включается файл, соответствующий этой зависимости (например, <code>/etc/conf.d/net</code>).</p>


	<p>4.e. Изменение поведения уровней запуска</p>


	<h3 id="Кто-от-этого-выиграет">Кто от этого выиграет?<a href="#Кто-от-этого-выиграет" class="wiki-anchor">&para;</a></h3>


	<p>Большинству пользователей ноутбуков знакома ситуация: дома вам нужен запуск <span class="bluecode" >net.eth0</span>, а в дороге, наоборот, запуск <span class="bluecode" >net.eth0</span> не нужен (так как сеть недоступна). В Calculate можно изменять поведение уровней запуска по своему усмотрению.</p>


	<p>Например вы можете создать второй загружаемый уровень запуска «по умолчанию», в котором будут другие сценарии. Затем при загрузке вы сможете выбрать, какой из уровней по умолчанию следует использовать.</p>


	<h3 id="Использование-программного-уровня-softlevel">Использование программного уровня (softlevel)<a href="#Использование-программного-уровня-softlevel" class="wiki-anchor">&para;</a></h3>


	<p>Прежде всего, создайте каталог для своего второго уровня запуска «по умолчанию». Например, создадим уровень запуска <code>offline</code>. Пример создания каталога уровня запуска:</p>


	<pre><code>mkdir /etc/runlevels/offline</code></pre>


	<p>Добавьте необходимые сценарии инициализации в только что созданный уровень запуска. Например, чтобы получить точную копию уровня <span class="bluecode" >default</span>, за исключением <span class="bluecode" >net.eth0</span>:<br /><pre>
(копирование всех служб с уровня default в уровень offline)
# cd /etc/runlevels/default
# for service in *; do rc-update add $service offline; done
(удаление ненужных сценариев с уровня offline)
# rc-update del net.eth0 offline
(просмотр сценариев, запускаемых на уровне offline)
# rc-update show offline
(часть выведенного списка)
               acpid | offline
          domainname | offline
               local | offline
            net.eth0 |
</pre></p>


	<p>Теперь необходимо отредактировать конфигурацию загрузчика, добавив запись об уровне <span class="bluecode" >offline</span>. Например, в файле <code>/boot/grub/grub.conf</code>. Пример:<br /><pre>
title Автономное использование Calculate Linux
  root (hd0,0)
  kernel /boot/vmlinuz-5bf7e746 root=/dev/hda3 softlevel=offline
</pre></p>


	<p>Вуаля, все готово. Теперь, если при загрузке вы выберете вновь созданную запись, то вместо <span class="bluecode" >default</span> будет использоваться уровень <span class="bluecode" >offline</span>.</p>


	<h3 id="Использование-загрузочного-уровня-bootlevel">Использование загрузочного уровня (bootlevel)<a href="#Использование-загрузочного-уровня-bootlevel" class="wiki-anchor">&para;</a></h3>


	<p>Использование <em>загрузочного уровня</em> полностью аналогично использованию <em>программного уровня</em>. Единственная разница состоит в том, что вы определяете второй уровень "boot" вместо "default".</p>
</body>
</html>
