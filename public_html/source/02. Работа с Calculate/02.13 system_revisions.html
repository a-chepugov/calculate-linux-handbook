<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>system revisions</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
body { font:80% Verdana,Tahoma,Arial,sans-serif; }
h1, h2, h3, h4 {  font-family: "Trebuchet MS",Georgia,"Times New Roman",serif; }
ul.toc { padding: 4px; margin-left: 0; }
ul.toc li { list-style-type:none; }
ul.toc li.heading2 { margin-left: 1em; }
ul.toc li.heading3 { margin-left: 2em; }
a.wiki-anchor { display: none; margin-left: 6px; text-decoration: none; }
a.wiki-anchor:hover { color: #aaa !important; text-decoration: none; }
h1:hover a.wiki-anchor, h2:hover a.wiki-anchor, h3:hover a.wiki-anchor { display: inline; color: #ddd; }
pre {font-size:133% }
</style>
</head>
<body>
<h1 id="Ревизии-системы">Ревизии системы<a href="#Ревизии-системы" class="wiki-anchor">&para;</a></h1>


	<ul class="toc"><li class="heading1"><a href="#Ревизии-системы">Ревизии системы</a></li>
<li class="heading2"><a href="#Формирование-состава-пакетов">Формирование состава пакетов</a></li>
<li class="heading2"><a href="#Управление-world-файлом-при-помощи-шаблонов">Управление world-файлом при помощи шаблонов</a></li>
<li class="heading2"><a href="#Ревизии-системы">Ревизии системы</a></li>
</ul>


	<h2 id="Формирование-состава-пакетов">Формирование состава пакетов<a href="#Формирование-состава-пакетов" class="wiki-anchor">&para;</a></h2>


	<p>По мере установки новых программ формируется системный файл (/var/lib/portage/world), содержащий список установленных пакетов. Файл содержит неполный список пакетов, установленных в системе. В нём отсутствуют пакеты, вычисляемые по зависимостям, например библиотеки.</p>


	<p>В качестве примера, установим электронные таблицы Gnumeric, выполнив:</p>


	<pre><code>emerge -a gnumeric</code></pre>


	<p>при выполнении пакетный менеджер может предложить установить несколько пакетов - сам <code>app-office/gnumeric</code>, а так же необходимые для работы пакеты <code>gnome-extra/libgsf</code> и <code>x11-libs/goffice</code>. В world-файл будет добавлен только пакет <code>app-office/gnumeric</code>, - пакет, который вы указали в качестве параметра <noindex><a href="/main/ru/emerge">emerge</a></noindex>.</p>


	<p>При удалении Gnumeric:</p>


	<pre><code>emerge -C gnumeric</code></pre>


	<p>пакет <code>app-office/gnumeric</code> будет удалён из world-файла, при этом все зависимые пакеты останутся в системе.</p>


	<p>Для удаления зависимостей, выполните:</p>


	<pre><code>emerge -ac</code></pre>


	<p>При выполнении этой команды сформируется дерево пакетов исходя из списка в world-файле, с включением зависимостей и, в случае наличия в системе установленных и не связанных пакетов, будет предложено их удалить.</p>


	<h2 id="Управление-world-файлом-при-помощи-шаблонов">Управление world-файлом при помощи шаблонов<a href="#Управление-world-файлом-при-помощи-шаблонов" class="wiki-anchor">&para;</a></h2>


	<p>Начиная с 13-й версии Calculate Linux изменилась система управления составом пакетов дистрибутива. В предыдущих версиях системы дерево зависимостей формировалось через так называемые мета-пакеты, содержащие только необходимые зависимости. Такой подход имел свои плюсы и минусы. В любой момент новая версия одного из мета-пакетов могла включить новую программу или исключить либо принудительно удалить другую. Мета-пакеты также успешно справлялись с возможными блокировками, которые могут возникнуть при формировании дерева зависимостей. Основной недостаток же был в сложности удаления предустановленных программ пользователем.</p>


	<p>Сейчас помимо пакетного менеджера, в world-файл могут вносить изменения утилиты Calculate. Это позволило избавиться от мета-пакетов. Во время выполнения синхронизации дерева портежей и оверлея, содержащего шаблоны утилит Calculate командой <code>eix-sync</code>, происходит вызов cl-core, который в свою очередь обрабатывает <noindex><a href="/main/ru/calculate_utilities_templates">шаблоны</a></noindex>.</p>


	<p>При помощи шаблонов формируются версии состава пакетов дистрибутива. К примеру, в случае замены одной программы на другую, вторая будет записана в world-файл вместо первой. Шаблоны позволяют гибко формировать world-файл, учитывая наличие заменяемой программы в системе.</p>


	<p>Версию world-файла можно посмотреть в <code>/etc/calculate/ini.env</code>, пример:<br /><pre>
[update]
world = 22
</pre></p>


	<p>Шаблоны формирования <code>world</code> на данный момент можно посмотреть здесь:<br /><pre>
/var/lib/layman/calculate/profiles/templates/3.1/6_ac_update_sync/world/
</pre></p>


Шаблоны делятся на две группы:
	<ul>
	<li>Формирование world-файла с нуля;</li>
		<li>Обновление текущего <code>world</code>: удаление, замена, добавление пакетов;</li>
	</ul>


	<p>Шаблоны разделяются на категории, такие как graphics, network, multimedia, и т.д., в каждой из них перечислены необходимые для дистрибутива пакеты.</p>


	<p>Шаблоны разделены на версии таким образом, что в каждом из них описаны правила обновления с предыдущей версии, пример:</p>


<pre>
#удалить geeqie в CLD
#?os_linux_shortname==CLD#
!media-gfx/geeqie
#os_linux_shortname#

# добавить catfish в CLDX
#?os_linux_shortname==CLDX#
dev-util/catfish
#os_linux_shortname#

# заменить chromium на firefox
#?pkg(www-client/chromium)!=#
www-client/firefox
#pkg#
</pre>

	<p>Обновить world-файл можно выполнить и вручную, при помощи команды:<br /><pre>
cl-update --update-rev
</pre></p>


	<p>Заново сформировать world-файл, без учёта установленных программ:<br /><pre>
cl-update --rebuild-world
</pre></p>


	<p>Сформировать world-файл исходя из лога установленных программ, без учёта предустановленных программ:<br /><pre>
regenworld
</pre></p>


	<h2 id="Ревизии-системы">Ревизии системы<a href="#Ревизии-системы" class="wiki-anchor">&para;</a></h2>


Изменения в формировании файла world также повлияли на систему исправления ошибок/настроек в дистрибутиве. Ранее исправление ошибок происходило при обновлении пакетов и имело следующие недостатки:
	<ul>
	<li>создание новых ревизии пакетов (чаще мета пакетов), для исправления во время полного обновления системы</li>
		<li>переустановка мета пакетов вызывала повторное наложение шаблонов для исправления</li>
		<li>создание ревизий для пакетов, не связанных с этой ошибкой, если исправление нужно внести до выполнения обновлений определенных пакетов</li>
		<li>ошибка не будет исправлена если не будет переустановлен необходимый пакет</li>
	</ul>


	<p>Новое исправление ошибок и настроек запускается командой <code>cl-udpate --update-rev</code> и не привязана к конкретным пакетам. Команда запускается с обновлением <code>world</code> файла, при выполнении eix-sync.</p>


	<p>Все исправления содержатся в шаблонах 6_ac_update_sync/revision. Исправление может быть как скриптом, так и указанием списка пакетов, которые нужно перенастроить. Каждое исправление привязано к конкретной ревизии.<br />Установленный дистрибутив содержит ревизию системы в файле <code>/etc/calculate/ini.env</code>, поэтому одни и те же исправления не будут применены несколько раз.</p>


	<p>Еще одним преимуществом такого подхода является то, что обновление рабочих систем и подготовка образа дистрибутива происходит по одной схеме, что позволяет уменьшить количество ошибок при обновлении системы, не проявляющихся в стейджах.</p>
</body>
</html>
