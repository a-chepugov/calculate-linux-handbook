<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>calculate-sources</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
body { font:80% Verdana,Tahoma,Arial,sans-serif; }
h1, h2, h3, h4 {  font-family: "Trebuchet MS",Georgia,"Times New Roman",serif; }
ul.toc { padding: 4px; margin-left: 0; }
ul.toc li { list-style-type:none; }
ul.toc li.heading2 { margin-left: 1em; }
ul.toc li.heading3 { margin-left: 2em; }
a.wiki-anchor { display: none; margin-left: 6px; text-decoration: none; }
a.wiki-anchor:hover { color: #aaa !important; text-decoration: none; }
h1:hover a.wiki-anchor, h2:hover a.wiki-anchor, h3:hover a.wiki-anchor { display: inline; color: #ddd; }
pre {font-size:133% }
</style>
</head>
<body>
<h1 id="calculate-sources">calculate-sources<a href="#calculate-sources" class="wiki-anchor">&para;</a></h1>


Пакет sys-kernel/calculate-sources отличается других пакетов '*sources' из портежей тем, что позволяет автоматизировать сборку ядра Linux:
	<ul>
	<li>наложение патчей при помощи шаблонов;</li>
		<li>создание конфигурации при помощи шаблонов;</li>
		<li>компиляция ядра и модулей;</li>
		<li>установка ядра в систему</li>
	</ul>


	<h2 id="Используемые-USE-флаги">Используемые USE флаги<a href="#Используемые-USE-флаги" class="wiki-anchor">&para;</a></h2>


Для управления порядком сборки используются следующие USE флаги:
	<ul>
	<li>при включенном USE флаге 'vmlinuz' во время сборки пакета ядро и модули будут скомпилированы и помещены в /boot и /lib соответственно.</li>
		<li>флаг 'minimal' используется для удаления из системы исходного кода собранного ядра, при этом в исходниках остаются только файлы, необходимые для сборки сторонних модулей ядра.</li>
	</ul>


	<p>Для сборки ядра и удаления исходного кода ebuild использует различные версии calculate-kernel е-классов.</p>


	<h2 id="Патчи-на-ядро">Патчи на ядро<a href="#Патчи-на-ядро" class="wiki-anchor">&para;</a></h2>


	<p>До марта 2013 патчи хранились в архивах calculate-sources-3.X.tar.bz2, что приводило к тому, что при обновлении одного из патчей (например при обновлении подверсии ядра) приходилось создавать новые архивы с дополнительными номерами (версии, ревизии и т.д.) и усложнять ebuild-ы.</p>


В связи с изменением способа наложения патчей во время сборки пакета, появилась возможность перенести патчи в шаблоны утилит Calculate, получив дополнительные преимущества:
	<ul>
	<li>разделять патчи на десктопные и серверные;</li>
		<li>использовать разные патчи для разных версий ядра</li>
	</ul>


Caluclate-sources использует следующие основные патчи:
	<ul>
	<li>aufs3 - файловая система, производящая каскадно-объединённое монтирование других файловых систем, используемая для запуска liveCD;</li>
		<li>fbcondecor - декорации в консоли</li>
	</ul>


и дополнительные, используемые в десктопных системах:
	<ul>
	<li>TuxOnIce - используется для ускорения "засыпания" и "пробуждения" компьютера;</li>
		<li>BFQ - I/O планировщик, созданный как замена CFQ (и основан на его коде), основная мысль – более честное разделение I/O между процессами.</li>
	</ul>


	<h3 id="Пользовательские-патчи">Пользовательские патчи<a href="#Пользовательские-патчи" class="wiki-anchor">&para;</a></h3>


	<p>Выполнение патчей происходит при событии компиляция пакета с действием <code>ac_install_patch</code> относительно пути <code>S</code> (<code>"${WORKDIR}/${P}"</code>), фильтрация по пакетам и версиям осуществляется через функцию merge(), формат шаблонов обычно <code>diff</code> (представляющие обычные патчи). Таким образом в простейшем варианте необходим файл патча со следующим заголовком:</p>


<pre>
# Calculate format=diff install.ac_install_patch==on&#38;&#38;merge(sys-kernel/calculate-sources)&gt;=версия
...
содержимое патча
...
</pre>

	<h2 id="Конфигурация-ядра">Конфигурация ядра<a href="#Конфигурация-ядра" class="wiki-anchor">&para;</a></h2>


	<p>До изменения системы наложения патчей конфигурация ядра хранилась в оверлее profiles/kernel в виде готового конфигурационного файла как для сервера, так и для десктопа.</p>


В связи с изменением метода наложения патчей на пакет изменился и способ создания конфигурационного файла, что дало ряд преимуществ:
	<ul>
	<li>нет разделения настроек на десктопные и серверные ядра (серверное ядро получается из конфигурации ядра, выполнением изменений по шаблону);</li>
		<li>параметры ядра, которые необходимо изменить при наличии патчей вынесены в отдельные шаблоны;</li>
		<li>возможность менять параметры ядра, патчи и маскировку не затрагивая ebuild-файлы</li>
	</ul>


	<h3 id="Пользовательские-параметры-ядра">Пользовательские параметры ядра<a href="#Пользовательские-параметры-ядра" class="wiki-anchor">&para;</a></h3>


	<p>Так как создание конфигурацинного файла происходит при сборке пакета, то для изменения параметров ядра необходимо создать файл с измененными параметрами, связанный с действием <code>ac_install_patch</code>. Например, чтобы включить в ядро файловые системы EXT2, EXT3 и EXT4 можно создать следующий файл:</p>


<pre>
# Calculate name=.config format=openrc install.ac_install_patch==on&#38;&#38;merge(sys-kernel/calculate-sources)&gt;=версия
CONFIG_EXT2_FS=y
CONFIG_EXT3_FS=y
CONFIG_EXT4_FS=y
</pre>

	<h2 id="Порядок-маскировки-ядер">Порядок маскировки ядер<a href="#Порядок-маскировки-ядер" class="wiki-anchor">&para;</a></h2>


	<p>Если ядро находится в hard маске, то это означает что оно еще не готово для полноценного использования: не все необходимые патчи, не готова конфигурация, в ходе эксплуатации выявлены критичные ошибки, ошибки во время сборки. После решения выше перечисленных задач с ядра снимается hard маска, и оно остаётся в маске по keywords, пока не будет использовано в одном из стейджей.</p>


	<h2 id="Имена-ядер">Имена ядер<a href="#Имена-ядер" class="wiki-anchor">&para;</a></h2>


	<p>При установке ядра из пакета <code>calculate-sources</code> с включенным USE-флагом <em>vmlinuz</em> происходит компиляция и установка ядра в директорию <code>/boot</code>. К именам файлов <code>vmlinuz</code>, <code>config</code>, <code>initramfs</code> и <code>System.map</code> дописывается окончание, состоящее из версии ядра, архитектуры и сокращенного имени дистрибутива (пример: "-3.9.7-i686-CLD"). В случае наличия таких файлов в директории <code>/boot</code>, к старым версиям дописывается окончание "<code>.old</code>".</p>


	<p>На ядро и вспомогательные файлы создаются символические ссылки. Для того чтобы не модифицировать загрузчик, имена символических ссылок не подлежат изменению. Символические ссылки были необходимы для Legacy Grub. Grub 2 сам автоматически определяет используемые файлы для формирования своего конфигурационного файла. В ближайших версиях символические ссылки и kernel_uid будут удалены.</p>


	<p>При необходимости, сгенерировать настройки Grub можно командой:</p>


<pre>
cl-setup-boot
</pre>

	<h2 id="Удаление-старых-версий-ядра">Удаление старых версий ядра<a href="#Удаление-старых-версий-ядра" class="wiki-anchor">&para;</a></h2>


	<p>Старые версии ядра удаляются при удалении соответствующих версий пакета <code>calculate-sources</code>. Поэтому, если вы не хотите оставлять их в системе, убедившись, что новое ядро работает нормально, удалите ненужные пакеты:</p>


<pre>
emerge -c
</pre>

	<p>Если же необходимо удалить только исходный код ядра, оставив собранное ядро, модули и конфигурационный файл - выключите автоматическое удаление в файле <code>/etc/calculate/ini.env</code></p>


<pre>
[update]
remove_kernel = off
</pre>
</body>
</html>
