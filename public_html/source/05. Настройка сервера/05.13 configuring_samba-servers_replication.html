<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>configuring samba-servers replication</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
body { font:80% Verdana,Tahoma,Arial,sans-serif; }
h1, h2, h3, h4 {  font-family: "Trebuchet MS",Georgia,"Times New Roman",serif; }
ul.toc { padding: 4px; margin-left: 0; }
ul.toc li { list-style-type:none; }
ul.toc li.heading2 { margin-left: 1em; }
ul.toc li.heading3 { margin-left: 2em; }
a.wiki-anchor { display: none; margin-left: 6px; text-decoration: none; }
a.wiki-anchor:hover { color: #aaa !important; text-decoration: none; }
h1:hover a.wiki-anchor, h2:hover a.wiki-anchor, h3:hover a.wiki-anchor { display: inline; color: #ddd; }
pre {font-size:133% }
</style>
</head>
<body>
<h1 id="Настройка-репликации-Samba-серверов">Настройка репликации Samba серверов<a href="#Настройка-репликации-Samba-серверов" class="wiki-anchor">&para;</a></h1>


	<ul class="toc right"><li class="heading1"><a href="#Настройка-репликации-Samba-серверов">Настройка репликации Samba серверов</a></li>
<li class="heading2"><a href="#Введение">Введение</a></li>
<li class="heading2"><a href="#Настройка-и-запуск-репликации">Настройка и запуск репликации</a></li>
<li class="heading3"><a href="#Резервное-копирование">Резервное копирование</a></li>
<li class="heading3"><a href="#Настройка-реплицирования-сервисов">Настройка реплицирования сервисов</a></li>
<li class="heading3"><a href="#Перенос-настроек-репликации-на-другие-серверы">Перенос настроек репликации на другие серверы</a></li>
<li class="heading3"><a href="#Применение-настроек-репликации-на-других-серверах">Применение настроек репликации на других серверах</a></li>
<li class="heading2"><a href="#Отключение-репликации">Отключение репликации</a></li>
<li class="heading2"><a href="#Поддержка-со-стороны-клиента">Поддержка со стороны клиента</a></li>
</ul>


	<h2 id="Введение">Введение<a href="#Введение" class="wiki-anchor">&para;</a></h2>


	<p>Часто возникает необходимость организации функционирования информационной системы с единой базой данных на нескольких серверах. Причиной этого становится, как правило, наличие на предприятии удаленных подразделений (территориально-распределенная структура предприятия). В этом случае приходится решать проблему организации передачи данных. Для решения данной проблемы используется <em>механизм репликации</em>.</p>


	<p><em>Репликация</em> — механизм синхронизации содержимого нескольких копий объекта (база данных LDAP). Репликация — это процесс, под которым понимается копирование данных из одного источника на множество других и наоборот.<br />При репликации изменения, сделанные в одной копии объекта, могут быть распространены в другие копии.</p>


	<p>Репликация Samba подразумевает, то что на серверах, включенных в репликацию, будут одинаковые списки пользователей, и изменения, проведенные на одном из этих серверов, касающиеся учетных записей unix и samba, будут автоматически перенесены на остальные сервера.</p>


	<p><em>Поддержка репликации LDAP включена в пакет calculate-server начиная с версии 2.0.7</em>.</p>


	<h2 id="Настройка-и-запуск-репликации">Настройка и запуск репликации<a href="#Настройка-и-запуск-репликации" class="wiki-anchor">&para;</a></h2>


	<h3 id="Резервное-копирование">Резервное копирование<a href="#Резервное-копирование" class="wiki-anchor">&para;</a></h3>


	<p>Перед тем как начинать настраивать репликацию, рекомендуется сделать резервную копию настроек, чтобы в случае некорректных действий не потерять данные:<br /><pre>
cl-backup
</pre><br />Для восстановления данных из последней резервной копии используйте команду:<br /><pre>
cl-backup -r
</pre></p>


	<h3 id="Настройка-реплицирования-сервисов">Настройка реплицирования сервисов<a href="#Настройка-реплицирования-сервисов" class="wiki-anchor">&para;</a></h3>


	<p>Добавление samba сервиса в репликацию и указание серверов производится командой <br /><pre>
cl-replication -r &lt;полные имена серверов через запятую&gt; samba
</pre><br />Для получения полного имени сервера используйте команду <em>hostname -f</em></p>


	<p>При указании списка серверов репликации samba сервиса, для них автоматически добавляется репликация unix сервиса.</p>


	<h3 id="Перенос-настроек-репликации-на-другие-серверы">Перенос настроек репликации на другие серверы<a href="#Перенос-настроек-репликации-на-другие-серверы" class="wiki-anchor">&para;</a></h3>


	<p>Для того, чтобы перенести настройки репликации на другие серверы необходимо:<br />*на сервере, где настроена репликация, сделать резервную копию настроек: <br /><pre>
cl-backup
</pre><br />*скопировать полученную резервную копию на все серверы, включенные в репликацию:<br /><pre>
scp /var/calculate/server-backup/ldap/&lt;последний бэкап&gt;.tar.bz2 root@otherserver:/var/calculate/server-backup/ldap/
</pre></p>


	<h3 id="Применение-настроек-репликации-на-других-серверах">Применение настроек репликации на других серверах<a href="#Применение-настроек-репликации-на-других-серверах" class="wiki-anchor">&para;</a></h3>


	<p>Для применения настроек репликации на других серверах необходимо выполнить на них команду<br /><pre>
cl-rebuild --repl
</pre></p>


	<h2 id="Отключение-репликации">Отключение репликации<a href="#Отключение-репликации" class="wiki-anchor">&para;</a></h2>


	<p>Для отключения репликации сервиса на сервере используется команда:<br /><pre>
cl-replication --off &lt;сервис&gt;
</pre></p>


	<h2 id="Поддержка-со-стороны-клиента">Поддержка со стороны клиента<a href="#Поддержка-со-стороны-клиента" class="wiki-anchor">&para;</a></h2>


	<p>Репликацию поддерживает пакет calculate-client начиная с версии 2.0.13.</p>


Последовательность действий <em>клиента</em>:
	<ol>
	<li>при входе в сеанс <em>клиент</em> синхронизирует профиль с текущим сервером;</li>
		<li>определяет включена ли репликация на сервере;</li>
		<li>если включена репликация, считывает из LDAP информацию о местоположении последней копии профиля и при необходимости синхронизирует профиль пользователя с удаленным сервером;</li>
		<li>при выходе из сеанса профиль записывается на текущий сервер;</li>
		<li>в случае успешной синхронизации с удаленным сервером, делается пометка в LDAP записи (реплицируемой на все сервера), о новом расположении последней копии профиля.</li>
	</ol>
</body>
</html>
