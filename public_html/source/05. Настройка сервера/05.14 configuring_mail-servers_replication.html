<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>configuring mail-servers replication</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
body { font:80% Verdana,Tahoma,Arial,sans-serif; }
h1, h2, h3, h4 {  font-family: "Trebuchet MS",Georgia,"Times New Roman",serif; }
ul.toc { padding: 4px; margin-left: 0; }
ul.toc li { list-style-type:none; }
ul.toc li.heading2 { margin-left: 1em; }
ul.toc li.heading3 { margin-left: 2em; }
a.wiki-anchor { display: none; margin-left: 6px; text-decoration: none; }
a.wiki-anchor:hover { color: #aaa !important; text-decoration: none; }
h1:hover a.wiki-anchor, h2:hover a.wiki-anchor, h3:hover a.wiki-anchor { display: inline; color: #ddd; }
pre {font-size:133% }
</style>
</head>
<body>
<h1 id="Настройка-репликации-почтовых-серверов">Настройка репликации почтовых серверов<a href="#Настройка-репликации-почтовых-серверов" class="wiki-anchor">&para;</a></h1>


	<ul class="toc right"><li class="heading1"><a href="#Настройка-репликации-почтовых-серверов">Настройка репликации почтовых серверов</a></li>
<li class="heading2"><a href="#Определения">Определения</a></li>
<li class="heading2"><a href="#Схемы-использования-репликации">Схемы использования репликации</a></li>
<li class="heading3"><a href="#1-Почтовый-домен-без-использования-глобальной-сети">1. Почтовый домен без использования глобальной сети</a></li>
<li class="heading3"><a href="#2-Почтовый-домен-c-использованием-глобальной-сети">2. Почтовый домен c использованием глобальной сети</a></li>
<li class="heading3"><a href="#3-Почтовый-домен-с-почтовым-релеем">3. Почтовый домен с почтовым релеем</a></li>
<li class="heading2"><a href="#Настройка-и-запуск-репликации">Настройка и запуск репликации</a></li>
<li class="heading3"><a href="#Резервное-копирование">Резервное копирование</a></li>
<li class="heading3"><a href="#Настройка-реплицирования-сервисов">Настройка реплицирования сервисов</a></li>
<li class="heading3"><a href="#Перенос-настроек-репликации-на-другие-сервера">Перенос настроек репликации на другие сервера</a></li>
<li class="heading3"><a href="#Применение-настроек-репликации-на-других-серверах">Применение настроек репликации на других серверах</a></li>
<li class="heading3"><a href="#Пример-создания-почтового-ящика">Пример создания почтового ящика</a></li>
<li class="heading2"><a href="#Описание-реализации">Описание реализации</a></li>
</ul>


	<p>Поддержка почтовой репликации включена в пакет <a href="calculate-server.html" class="wiki-page new">calculate-server</a> начиная с версии 2.0.9.</p>


	<h2 id="Определения">Определения<a href="#Определения" class="wiki-anchor">&para;</a></h2>


	<p>Интранет - в отличие от сети интернет, это внутренняя частная ceть организации. Как правило, интранет — это интернет в миниатюре, который построен на использовании протокола IP для обмена и совместного использования некоторой части информации внутри этой организации.</p>


	<p>Почтовый домен - это совокупность почтовых ящиков, групп и списков рассылки, идентифицируемая единым доменным именем. Это имя называется основным именем почтового домена. Все почтовые ящики, группы и списки рассылки, относящиеся к одному почтовому домену имеют в адресе электронной почты общую часть после символа "@".</p>


	<p>Репликация почтовых серверов - служит для возможности создания почтовых доменов внутри сети интранет, состоящей из нескольких почтовых серверов. Серверы, участвующие в репликации, могут выступать в роли почтового сервера либо почтового <em>релея</em>.</p>


	<p>Почтовый релей — сервер, занимающийся получением/пересылкой электронной почты. Релей обеспечивает прием письма, временное хранение (от нескольких минут до недели), пересылку сообщения почтовому серверу (или следующему почтовому релею).</p>


	<p>Почтовый сервер - сервер, который может выполнять не только функции почтового релея, но также хранит пользовательскую почту и предоставляет доступ к этой почте по протоколам POP3 и/или IMAP.</p>


	<h2 id="Схемы-использования-репликации">Схемы использования репликации<a href="#Схемы-использования-репликации" class="wiki-anchor">&para;</a></h2>


	<p>Ниже приведены три схемы настройки репликации почтовых серверов. На приведенных схемах, синими стрелками обозначена входящая из интернета почта, фиолетовыми - исходящая в интернет, зелеными - пересылка почты внутри сети интранет.</p>


	<h3 id="1-Почтовый-домен-без-использования-глобальной-сети">1. Почтовый домен без использования глобальной сети<a href="#1-Почтовый-домен-без-использования-глобальной-сети" class="wiki-anchor">&para;</a></h3>


	<p style="text-align:center;"><img src="/attachments/download/205" alt="" /></p>


	<h4>Описание</h4>


	<p>В данной схеме почтовые серверы осуществляют пересылку почты только в пределах сети интранет. Почтовые сервера объединены в виртуальный почтовый домен (на примере: <em>maildomain.org</em>), благодаря чему все почтовые адреса выглядят как: "&lt;имя почтового ящика&gt;@maildomain.org".</p>


	<h4>Настройка схемы</h4>


Для настройки заданной схемы:
	<ul>
	<li>выполните настройку на одном из почтовых серверов (<a href="Unix.html" class="wiki-page">Unix</a> и <a href="Samba.html" class="wiki-page">Samba</a>) сервисов.</li>
		<li>настройте репликацию Unix и Mail сервисов, указав полные имена всех почтовых серверов, участвующих в репликации.</li>
		<li>установите настройки репликации на остальные почтовые серверы участвующие в репликации.</li>
	</ul>


	<h3 id="2-Почтовый-домен-c-использованием-глобальной-сети">2. Почтовый домен c использованием глобальной сети<a href="#2-Почтовый-домен-c-использованием-глобальной-сети" class="wiki-anchor">&para;</a></h3>


	<p style="text-align:center;"><img src="/attachments/download/204" alt="" /></p>


	<h4>Описание</h4>


	<p>В отличие от первой схемы, здесь один из серверов принимает все письма, приходящие с внешних адресов, осуществляя доставку другим почтовым серверам внутри интранет. Каждый почтовый сервер должен иметь реальный IP адрес для отправки писем внешним адресатам. Для такого сервера должна присутствовать <noindex><a href="http://ru.wikipedia.org/wiki/Запись_MX" rel="nofollow" target="_blank" class="external">MX запись</a></noindex> в DNS.</p>


	<h4>Настройка схемы</h4>


	<p>Настройка заданной схемы выполняется аналогично первой схеме.</p>


	<h3 id="3-Почтовый-домен-с-почтовым-релеем">3. Почтовый домен с почтовым релеем<a href="#3-Почтовый-домен-с-почтовым-релеем" class="wiki-anchor">&para;</a></h3>


	<p style="text-align:center;"><img src="/attachments/download/206" alt="" /></p>


	<h4>Описание</h4>


	<p>Особенностью схемы является наличие почтового реля, который берет на себя функции переадресации почты приходящей с внешних адресов. Благодаря репликации, почтовый сервер всегда знает хосты серверов всех почтовых ящиков обслуживаемых доменов.</p>


	<p>Отправка писем во внешние адреса осуществляется каждым сервером минуя почтовый релей.</p>


	<h4>Настройка схемы</h4>


Для настройки заданной схемы:
	<ul>
	<li>выполните настройку на одном из почтовых серверов (<a href="Unix.html" class="wiki-page">Unix</a> и <a href="Samba.html" class="wiki-page">Samba</a>) сервисов.</li>
		<li>настройте репликацию Unix и Mail сервисов, указав полные имена всех почтовых серверов участвующих в репликации, за исключением почтового релея, на котором репликация Unix сервиса будет отсутствовать.</li>
		<li>установите настройки репликации на остальные почтовые серверы участвующие в репликации.</li>
	</ul>


	<h2 id="Настройка-и-запуск-репликации">Настройка и запуск репликации<a href="#Настройка-и-запуск-репликации" class="wiki-anchor">&para;</a></h2>


	<h3 id="Резервное-копирование">Резервное копирование<a href="#Резервное-копирование" class="wiki-anchor">&para;</a></h3>


	<p>Перед тем как начинать настраивать почтовую репликацию, рекомендуется сделать резервную копию настроек, чтобы в случае некорректных действий не потерять данные:<br /><pre>
cl-backup
</pre><br />Для восстановления данных из последней резервной копии используйте команду:<br /><pre>
cl-backup -r
</pre></p>


	<h3 id="Настройка-реплицирования-сервисов">Настройка реплицирования сервисов<a href="#Настройка-реплицирования-сервисов" class="wiki-anchor">&para;</a></h3>


	<p>Добавление mail сервиса в репликацию и указание серверов производится командой<br /><pre>
cl-replication -r &lt;полные имена серверов через запятую&gt; mail
</pre><br />Для получения полного имени сервера используйте команду:<br /><pre>
hostname -f
</pre></p>


	<p>При репликации только mail сервиса все перечисленные серверы будут почтовыми релеями. Для того чтобы сделать их (все или некоторые) почтовыми серверами, необходимо добавить их в репликацию unix сервиса. Это делается командой:<br /><pre>
cl-replication -r &lt;полные имена серверов через запятую&gt; unix
</pre></p>


	<h3 id="Перенос-настроек-репликации-на-другие-сервера">Перенос настроек репликации на другие сервера<a href="#Перенос-настроек-репликации-на-другие-сервера" class="wiki-anchor">&para;</a></h3>


Для того, чтобы перенести настройки репликации на другие серверы необходимо:
	<ul>
	<li>на сервере, где настроена репликация, сделать резервную копию настроек: <br /><pre>
cl-backup
</pre></li>
		<li>скопировать полученную резервную копию на все серверы, включенные в репликацию:<br /><pre>
scp /var/calculate/server-backup/ldap/&lt;последний бэкап&gt;.tar.bz2 root@otherserver:/var/calculate/server-backup/ldap/
</pre></li>
	</ul>


	<h3 id="Применение-настроек-репликации-на-других-серверах">Применение настроек репликации на других серверах<a href="#Применение-настроек-репликации-на-других-серверах" class="wiki-anchor">&para;</a></h3>


	<p>Для применения настроек репликации на других серверах необходимо выполнить на них команду<br /><pre>
cl-rebuild --repl
</pre></p>


	<h3 id="Пример-создания-почтового-ящика">Пример создания почтового ящика<a href="#Пример-создания-почтового-ящика" class="wiki-anchor">&para;</a></h3>


	<p>После настройки репликации серверов, вы можете создавать пользователей на любом из почтовых серверов. Для этого используйте команду cl-useradd с параметром "-e" (альтернативный почтовый адрес), где в качестве параметра следует указывать почтовый домен.</p>


	<p>Пример:<br /><pre>
cl-useradd -e user1@maildomain.org user1 mail
</pre></p>


	<h2 id="Описание-реализации">Описание реализации<a href="#Описание-реализации" class="wiki-anchor">&para;</a></h2>


	<p>Репликация mail сервиса заключается в том, что реплицируются только почтовые алиасы.</p>


	<p>Алиас — запись (в данном случае в LDAP), которая говорит о том: какие альтернативные почтовые адреса соответствуют реальным почтовым адресам (в данном случае один реальный почтовый адрес).</p>


	<p>При отправке письма почтовый сервер просматривает по LDAP: принадлежит ли адресат письма текущему почтовому домену. Если принадлежит, то по записи LDAP определяется почтовый сервер получатель этого письма, и письмо отправляется на определенный почтовый сервер в интранете. Если же адресат не принадлежит текущему почтовому домену, то письмо отправляется в интернет.</p>
</body>
</html>
