<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>xpak</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
body { font:80% Verdana,Tahoma,Arial,sans-serif; }
h1, h2, h3, h4 {  font-family: "Trebuchet MS",Georgia,"Times New Roman",serif; }
ul.toc { padding: 4px; margin-left: 0; }
ul.toc li { list-style-type:none; }
ul.toc li.heading2 { margin-left: 1em; }
ul.toc li.heading3 { margin-left: 2em; }
a.wiki-anchor { display: none; margin-left: 6px; text-decoration: none; }
a.wiki-anchor:hover { color: #aaa !important; text-decoration: none; }
h1:hover a.wiki-anchor, h2:hover a.wiki-anchor, h3:hover a.wiki-anchor { display: inline; color: #ddd; }
pre {font-size:133% }
</style>
</head>
<body>
<h1 id="XPAK">XPAK<a href="#XPAK" class="wiki-anchor">&para;</a></h1>


	<h2 id="НАЗВАНИЕ">НАЗВАНИЕ<a href="#НАЗВАНИЕ" class="wiki-anchor">&para;</a></h2>


	<p>xpak - формат данных XPAK, используемый в бинарных пакетах Portage</p>


	<h2 id="КРАТКОЕ-ОПИСАНИЕ">КРАТКОЕ ОПИСАНИЕ<a href="#КРАТКОЕ-ОПИСАНИЕ" class="wiki-anchor">&para;</a></h2>


	<p>К каждому бинарному пакету Gentoo прилагаются данные xpak, которые содержат различную информацию времени сборки - например, USE-флаги, с которыми пакет был скомпилирован, исходный ебилд, переменные окружения, значения переменных CFLAGS и CXXFLAGS и т.д.</p>


	<h2 id="ПРИМЕЧАНИЯ">ПРИМЕЧАНИЯ<a href="#ПРИМЕЧАНИЯ" class="wiki-anchor">&para;</a></h2>


	<h3 id="-Типы-данных"> Типы данных<a href="#-Типы-данных" class="wiki-anchor">&para;</a></h3>


	<p>Ниже описаны все рассматриваемые в данной документации случаи.</p>


	<p>Целое число</p>


	<p style="padding-left:4em;">Все отступы/длины являются беззнаковыми 32-разрядными целыми числами, с порядком следования байт от старшего к младшему.</p>


	<p>Строка</p>


	<p style="padding-left:4em;">Все строки в кодировке ASCII и не оканчиваются на NUL (кавычки - только для иллюстрации)</p>


	<p>Значение</p>


	<p style="padding-left:4em;">Текущие значения отдельных записей xpak хранятся как строки.</p>


	<h3 id="-Вертикальная-черта"> Вертикальная черта<a href="#-Вертикальная-черта" class="wiki-anchor">&para;</a></h3>


	<p>Вертикальная черта '|' не является частью формата файла; она используется лишь для иллюстрации того, как значения отступа применяются к данным.</p>


	<h2 id="СИНТАКСИС">СИНТАКСИС<a href="#СИНТАКСИС" class="wiki-anchor">&para;</a></h2>


	<p>бинарный пакет (tbz2)</p>


<pre style="margin-left:4.0em;">
     |&lt;-отступ_xpak-&gt;| 
&lt;tar&gt;|&lt;    xpak     &gt;|&lt;отступ_xpak&gt;"STOP" 
</pre>

	<p>xpak</p>


<pre style="margin-left:4.0em;">
"XPAKPACK"&lt;строка_индекса&gt;&lt;строка_данных&gt;&lt;индекс&gt;&lt;данные&gt;"XPAKSTOP" 
</pre>

	<p>индекс</p>


<pre style="margin-left:4.0em;">
|&lt;-------------строка_индекса-------------&gt;| 
|&lt;индекс1&gt;&lt;индекс2&gt;&lt;индекс3&gt;&lt;индекс4&gt;&lt;...&gt;| 
</pre>

	<p>индексN</p>


<pre style="margin-left:4.0em;">
          |&lt;-строка_имени-&gt;| 
&lt;строка_имени&gt;|&lt;   имя   &gt;|&lt;отступ_данных&gt;&lt;строка_данных&gt; 
</pre>

	<p>данные</p>


<pre style="margin-left:4.0em;">
|&lt;--------------строка_данных-------------&gt;| 
|&lt;-отступ_данныхN-&gt;|&lt;-строка_данныхN-&gt;| 
|&lt;     данные     &gt;|&lt;  данные_N   &gt;|&lt;данные&gt;| 
</pre>

	<h2 id="ПОДРОБНОЕ-ОПИСАНИЕ">ПОДРОБНОЕ ОПИСАНИЕ<a href="#ПОДРОБНОЕ-ОПИСАНИЕ" class="wiki-anchor">&para;</a></h2>


	<h3 id="-xpak"> xpak<a href="#-xpak" class="wiki-anchor">&para;</a></h3>


	<p>Если вы рассмотрите любой бинарный пакет Gentoo с помощью шестнадцатиричного редактора, вы обнаружите, что  он содержит собственно архив файлов, а далее бинарный блоб -  <em>xpak</em>, отступ, содержащий байты от начала <em>xpak'а</em> до конца файла - <em>отступ_xpak</em> и, наконец, строку <em>"STOP"</em>.</p>


<pre>
     |&lt;отступ_xpak&gt;| 
&lt;tar&gt;|&lt;---xpak----&gt;|&lt;отступ_xpak&gt;"STOP" 
</pre>

	<p>В приведенном примере вы можете видеть архив <em>tar</em>, связанный с ним <em>блоб_xpak</em>, <em>отступ_xpak</em> и, в конце, строку <em>"STOP"</em>.  Эти метаданные не рассматриваются как часть <em>xpak</em>, а скорее как часть бинарного пакета.</p>


	<p>Если мы возьмем значение оступа и отчитаем соответствующее ему количество байтов назад от начала <em>отступа_xpak</em>, то придем к блоку <em>xpak</em>, который начинается со строки <em>"XPAKPACK"</em>.</p>


	<p>Блок xpak состоит из строки <em>"XPAKPACK"</em>, длины  блока <em>индекса</em> (<em>строка_индекса</em>), длины блока <em>данных</em> (<em>строка_данных</em>), бинарный блоб <em>строки_индекса</em>, содержащий <em>индекс</em>, бинарный блоб <em>строки_данных</em>, содержащий <em>данные</em>, и строки <em>"XPAKSTOP"</em> в конце:</p>


<pre>
                               |&lt;строка_индекса&gt;|&lt;строка_данных&gt;| 
"XPAKPACK"&lt;строка_индекса&gt;&lt;строка_данных&gt;|&lt;--индекс--&gt;|&lt;--данные--&gt;|"XPAKSTOP" 
</pre>

	<p>Чтобы получить <em>индекс</em> и <em>данные</em>, мы отсекаем с конца <em>строки_данных</em> количество байт, соответствующее <em>строке_индекса</em> (блок <em>индекса</em>), а затем - байты, соответствующие следующей <em>строке_данных</em> (блок <em>данных</em>). Если мы всё сделали правильно, следующие байты будут представлять собой строку <em>"XPAKSTOP"</em> в формате ASCII.</p>


	<p>Все <em>данные</em> сведены в один большой блок; таким образом, чтобы их считать, необходимо знать фактическое положение каждого фрагмента информации в этом блоке. Эту информацию можно получить с помощью индексов, хранящихся в блоке <em>индекса</em>.</p>


	<h3 id="-_Блок-_индекса_"> <em>Блок _индекса</em><a href="#<del><em>Блок</del>_индекса</em>" class="wiki-anchor">&para;</a></h3>


	<p><em>Блок _индекса</em> включает ряд индексов:</p>


<pre>
|&lt;-----------------------строка_индексов----------------------&gt;| 
|&lt;индекс1&gt;&lt;индекс2&gt;&lt;индекс3&gt;&lt;индекс4&gt;&lt;индекс5&gt;&lt;индекс6&gt;&lt;индекс7&gt;| 
</pre>

	<p>Блок <em>индекса</em> содержит всю необходимую нам информацию для блока <em>данных</em>. Он содержит ряд отдельных индексов, которые все вместе составляют <em>строку_индексов</em>. Здесь нет разделения нулем или тому подобного.</p>


	<p>Каждый из этих элементов соответствует фрагменту данных в блоке <em>данных</em>: строка имени этого блока (<em>строка_имени), длина _строки_имени</em> в байтах, оступ блока (отступ_данныхN) и длина блока (_строка_данныхN):</p>


<pre>
          |&lt;строка_имени&gt;| 
&lt;строка_имени&gt;|&lt;--имя--&gt;|&lt;отступ_данныхN&gt;&lt;строка_данныхN&gt; 
</pre>

	<h3 id="-_Блок_данных_"> <em>Блок_данных</em><a href="#-<em>Блок_данных</em>" class="wiki-anchor">&para;</a></h3>


	<p><em>Блок_данных</em> содержит ряд фрагментов данных, которые в сумме образуют <em>строку_данных</em>:</p>


<pre>
|&lt;------------------------строка_данных------------------------&gt;| 
|&lt;данные1&gt;&lt;данные2&gt;&lt;данные3&gt;&lt;данные4&gt;&lt;данные5&gt;&lt;данные6&gt;&lt;данные7&gt;&lt;данные...&gt;| 
</pre>

	<p>Для выбора одного элемента данных нам понадобится <em>отступ_данных</em> и <em>строка_данных</em> из <em>индекса</em>.  Опираясь на них, мы можем рассчитать количество байтов в <em>строке_данных</em> от начала <em>блока_данных</em>, а затем отнять от них байты ближайшей следующей <em>строки_данных</em>. Тем самым мы получаем наш исходный блок данных:</p>


<pre>
|&lt;-----отступ_данныхN-----&gt;|&lt;--строка_данныхN-&gt;| 
|&lt;данные1данные2данные3данные...&gt;|&lt;нужные_нам_данные&gt;| 
</pre>

	<h2 id="ПРИМЕРЫ">ПРИМЕРЫ<a href="#ПРИМЕРЫ" class="wiki-anchor">&para;</a></h2>


	<p>Предположим, что у нас есть xpak, содержащий два фрагмента данных. Один из них именуется "file1" и содержит строку "ddDddDdd", а другой - "file2" и содержит строку "jjJjjJjj". Данные не содержат <em>"STOP"</em> или <em>отступ_xpak</em>, поскольку данный xpak не является частью бинарного пакета.</p>


	<p>Вот вывод шестнадцатиричных данных (построчно): <br /><pre>
00  58 50 41 4b 50 41 43 4b  00 00 00 20 00 00 00 10  |XPAKPACK... ....| 
10  00 00 00 04 66 69 6c 31  00 00 00 00 00 00 00 08  |....файл1........| 
20  00 00 00 04 66 69 6c 32  00 00 00 08 00 00 00 08  |....файл2........| 
30  64 64 44 64 64 44 64 64  6a 6a 4a 6a 6a 4a 6a 6a  |ddDddDddjjJjjJjj| 
40  58 50 41 4b 53 54 4f 50                           |XPAKSTOP| 
</pre></p>


	<p><em>Строка_индекса</em> имеет значение 32, а <em>строка_данных</em> - 16 (поскольку данные содержат 16 байт: "ddDddDdd" и "jjJjjJjj"). <br /><pre>
   |&lt;------"XPAKPACK"-----&gt;||    32     |    16     | 
00  58 50 41 4b 50 41 43 4b  00 00 00 20 00 00 00 10 
</pre></p>


	<p>А вот первый элемент индекса, значение <em>строки_имени</em> которого составляет 4, за ней идет строка "файл1", далее - отступ данных1 со значением 0 и данные1 со значением 8 (поскольку данные1 содержат 8 байт: "ddDddDdd"):<br /><pre>
   |     4     |&lt;--"файл1"-&gt;||отступ_данных1:0|строка_данных1:8| 
10  00 00 00 04 66 69 6c 31  00 00 00 00 00 00 00 08 
</pre></p>


	<p>Теперь рассмотрим второй элемент индекса, со значением <em>строки_индекса</em> 4; за ней идет строка индекса "файл2", отступ_данных2 со значением 8 и данные2 со значением 8 (поскольку данные2 содержат 8 байт: "jjJjjJjj"). <br /><pre>
   |     4     |&lt;--"файл2"-&gt;||отступ_данных2:8|строка_данных2:8| 
20  00 00 00 04 66 69 6c 32  00 00 00 08 00 00 00 08 
</pre></p>


<pre>
   |&lt;------"XPAKSTOP"-----&gt;| 
40  58 50 41 4b 53 54 4f 50 
</pre>

	<h2 id="АВТОРЫ">АВТОРЫ<a href="#АВТОРЫ" class="wiki-anchor">&para;</a></h2>


	<ul>
	<li>Lars Hartmann &lt;<a class="email" href="mailto:lars@chaotika.org">lars@chaotika.org</a>&gt;</li>
		<li>Mike Frysinger &lt;<a class="email" href="mailto:vapier@gentoo.org">vapier@gentoo.org</a>&gt;</li>
	</ul>


	<h2 id="СМ-ТАКЖЕ">СМ. ТАКЖЕ<a href="#СМ-ТАКЖЕ" class="wiki-anchor">&para;</a></h2>


	<p><strong><a href=".html" class="wiki-page">qtbz2</a></strong>(1), <strong><a href=".html" class="wiki-page">quickpkg</a></strong>(1), <strong><a href=".html" class="wiki-page">qxpak</a></strong>(1)</p>


	<h2 id="ПЕРЕВОД">ПЕРЕВОД<a href="#ПЕРЕВОД" class="wiki-anchor">&para;</a></h2>


	<ul>
	<li>Елена Гаврилова &lt;<a class="email" href="mailto:e.vl.gavrilova@yandex.ru">e.vl.gavrilova@yandex.ru</a>&gt;</li>
	</ul>


	<p>&nbsp;<br />&nbsp;</p>


	<p>Октябрь 2011</p>
</body>
</html>
