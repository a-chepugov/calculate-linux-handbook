# Настройка репликации почтовых серверов[¶](#Настройка-репликации-почтовых-серверов)

* [Настройка репликации почтовых серверов](#Настройка-репликации-почтовых-серверов)
* [Определения](#Определения)
* [Схемы использования репликации](#Схемы-использования-репликации)
* [1\. Почтовый домен без использования глобальной сети](#1-Почтовый-домен-без-использования-глобальной-сети)
* [2\. Почтовый домен c использованием глобальной сети](#2-Почтовый-домен-c-использованием-глобальной-сети)
* [3\. Почтовый домен с почтовым релеем](#3-Почтовый-домен-с-почтовым-релеем)
* [Настройка и запуск репликации](#Настройка-и-запуск-репликации)
* [Резервное копирование](#Резервное-копирование)
* [Настройка реплицирования сервисов](#Настройка-реплицирования-сервисов)
* [Перенос настроек репликации на другие сервера](#Перенос-настроек-репликации-на-другие-сервера)
* [Применение настроек репликации на других серверах](#Применение-настроек-репликации-на-других-серверах)
* [Пример создания почтового ящика](#Пример-создания-почтового-ящика)
* [Описание реализации](#Описание-реализации)

Поддержка почтовой репликации включена в пакет [calculate-server](calculate-server.html) начиная с версии 2.0.9\.

## Определения[¶](#Определения)

Интранет - в отличие от сети интернет, это внутренняя частная ceть организации. Как правило, интранет --- это интернет в миниатюре, который построен на использовании протокола IP для обмена и совместного использования некоторой части информации внутри этой организации.

Почтовый домен - это совокупность почтовых ящиков, групп и списков рассылки, идентифицируемая единым доменным именем. Это имя называется основным именем почтового домена. Все почтовые ящики, группы и списки рассылки, относящиеся к одному почтовому домену имеют в адресе электронной почты общую часть после символа "@".

Репликация почтовых серверов - служит для возможности создания почтовых доменов внутри сети интранет, состоящей из нескольких почтовых серверов. Серверы, участвующие в репликации, могут выступать в роли почтового сервера либо почтового _релея_.

Почтовый релей --- сервер, занимающийся получением/пересылкой электронной почты. Релей обеспечивает прием письма, временное хранение (от нескольких минут до недели), пересылку сообщения почтовому серверу (или следующему почтовому релею).

Почтовый сервер - сервер, который может выполнять не только функции почтового релея, но также хранит пользовательскую почту и предоставляет доступ к этой почте по протоколам POP3 и/или IMAP.

## Схемы использования репликации[¶](#Схемы-использования-репликации)

Ниже приведены три схемы настройки репликации почтовых серверов. На приведенных схемах, синими стрелками обозначена входящая из интернета почта, фиолетовыми - исходящая в интернет, зелеными - пересылка почты внутри сети интранет.

### 1\. Почтовый домен без использования глобальной сети[¶](#1-Почтовый-домен-без-использования-глобальной-сети)

![](/attachments/download/205)

#### Описание

В данной схеме почтовые серверы осуществляют пересылку почты только в пределах сети интранет. Почтовые сервера объединены в виртуальный почтовый домен (на примере: _maildomain.org_), благодаря чему все почтовые адреса выглядят как: "<имя почтового ящика\>@maildomain.org".

#### Настройка схемы
Для настройки заданной схемы:

* выполните настройку на одном из почтовых серверов ([Unix](Unix.html) и [Samba](Samba.html)) сервисов.
* настройте репликацию Unix и Mail сервисов, указав полные имена всех почтовых серверов, участвующих в репликации.
* установите настройки репликации на остальные почтовые серверы участвующие в репликации.

### 2\. Почтовый домен c использованием глобальной сети[¶](#2-Почтовый-домен-c-использованием-глобальной-сети)

![](/attachments/download/204)

#### Описание

В отличие от первой схемы, здесь один из серверов принимает все письма, приходящие с внешних адресов, осуществляя доставку другим почтовым серверам внутри интранет. Каждый почтовый сервер должен иметь реальный IP адрес для отправки писем внешним адресатам. Для такого сервера должна присутствовать [MX запись](http://ru.wikipedia.org/wiki/Запись_MX) в DNS.

#### Настройка схемы

Настройка заданной схемы выполняется аналогично первой схеме.

### 3\. Почтовый домен с почтовым релеем[¶](#3-Почтовый-домен-с-почтовым-релеем)

![](/attachments/download/206)

#### Описание

Особенностью схемы является наличие почтового реля, который берет на себя функции переадресации почты приходящей с внешних адресов. Благодаря репликации, почтовый сервер всегда знает хосты серверов всех почтовых ящиков обслуживаемых доменов.

Отправка писем во внешние адреса осуществляется каждым сервером минуя почтовый релей.

#### Настройка схемы
Для настройки заданной схемы:

* выполните настройку на одном из почтовых серверов ([Unix](Unix.html) и [Samba](Samba.html)) сервисов.
* настройте репликацию Unix и Mail сервисов, указав полные имена всех почтовых серверов участвующих в репликации, за исключением почтового релея, на котором репликация Unix сервиса будет отсутствовать.
* установите настройки репликации на остальные почтовые серверы участвующие в репликации.

## Настройка и запуск репликации[¶](#Настройка-и-запуск-репликации)

### Резервное копирование[¶](#Резервное-копирование)

Перед тем как начинать настраивать почтовую репликацию, рекомендуется сделать резервную копию настроек, чтобы в случае некорректных действий не потерять данные:  

    
    cl-backup
    

  
Для восстановления данных из последней резервной копии используйте команду:  

    
    cl-backup -r
    

### Настройка реплицирования сервисов[¶](#Настройка-реплицирования-сервисов)

Добавление mail сервиса в репликацию и указание серверов производится командой  

    
    cl-replication -r <полные имена серверов через запятую> mail
    

  
Для получения полного имени сервера используйте команду:  

    
    hostname -f
    

При репликации только mail сервиса все перечисленные серверы будут почтовыми релеями. Для того чтобы сделать их (все или некоторые) почтовыми серверами, необходимо добавить их в репликацию unix сервиса. Это делается командой:  

    
    cl-replication -r <полные имена серверов через запятую> unix
    

### Перенос настроек репликации на другие сервера[¶](#Перенос-настроек-репликации-на-другие-сервера)
Для того, чтобы перенести настройки репликации на другие серверы необходимо:

* на сервере, где настроена репликация, сделать резервную копию настроек:   

    
    cl-backup
    

* скопировать полученную резервную копию на все серверы, включенные в репликацию:  

    
    scp /var/calculate/server-backup/ldap/<последний бэкап>.tar.bz2 root@otherserver:/var/calculate/server-backup/ldap/
    

### Применение настроек репликации на других серверах[¶](#Применение-настроек-репликации-на-других-серверах)

Для применения настроек репликации на других серверах необходимо выполнить на них команду  

    
    cl-rebuild --repl
    

### Пример создания почтового ящика[¶](#Пример-создания-почтового-ящика)

После настройки репликации серверов, вы можете создавать пользователей на любом из почтовых серверов. Для этого используйте команду cl-useradd с параметром "-e" (альтернативный почтовый адрес), где в качестве параметра следует указывать почтовый домен.

Пример:  

    
    cl-useradd -e user1@maildomain.org user1 mail
    

## Описание реализации[¶](#Описание-реализации)

Репликация mail сервиса заключается в том, что реплицируются только почтовые алиасы.

Алиас --- запись (в данном случае в LDAP), которая говорит о том: какие альтернативные почтовые адреса соответствуют реальным почтовым адресам (в данном случае один реальный почтовый адрес).

При отправке письма почтовый сервер просматривает по LDAP: принадлежит ли адресат письма текущему почтовому домену. Если принадлежит, то по записи LDAP определяется почтовый сервер получатель этого письма, и письмо отправляется на определенный почтовый сервер в интранете. Если же адресат не принадлежит текущему почтовому домену, то письмо отправляется в интернет.